{% extends "base.html" %}

{% block extra_head %}
<style>
  .chat-wrap{
    max-width: 1100px;
    margin: 0 auto;
    height: calc(100vh - 170px);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .chat-head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
    flex:0 0 auto;
  }

  .chat-grid{
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:14px;
    margin-top:10px;
    flex:1 1 auto;
    min-height:0;
  }
  @media (max-width: 980px){
    .chat-wrap{
      height:auto;
      overflow:visible;
    }
    .chat-grid{
      grid-template-columns: 1fr;
      min-height:auto;
    }
  }

  .chat-card{
    border:1px solid var(--line);
    border-radius:18px;
    background:white;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  .chat-messages{
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    background:#f9fafb;
    flex:1 1 auto;
    min-height:0;
    max-height:none;
    overflow-y:auto;
  }

  .msg-row{
    display:flex;
    width:100%;
  }
  .msg-row.left{ justify-content:flex-start; }
  .msg-row.right{ justify-content:flex-end; }

  .msg{
    max-width: 78%;
    border-radius:16px;
    padding:8px 10px;
    border:1px solid var(--line);
    background:white;
    color:#111827;
    white-space:pre-wrap;
    line-height:1.35;
  }

  .msg.customer{
    border-color: var(--orangeLine);
    background: var(--orangeBg);
    color: var(--orangeText);
  }

  .msg-meta{
    margin-top:6px;
    font-size:12px;
    color: var(--muted);
    font-weight:700;
  }

  .chat-form{
    padding:10px 12px;
    border-top:1px solid var(--line);
    background:white;
    flex:0 0 auto;
  }

  .chat-actions{
    margin-top:10px;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    flex-wrap:wrap;
  }

  .side-card{
    border:1px solid var(--line);
    border-radius:18px;
    background:white;
    overflow:auto;
  }
  .side-card .pad{
    padding:10px 12px;
  }
  .side-title{
    font-weight:900;
    font-size:13px;
    margin-bottom:10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrap">
  <div class="chat-head">
    <div>
      <div class="title">{{ ticket.subject|default:"Ticket" }}</div>
      <p class="subtitle">
        Servis #{{ ticket.order.service_code|default:ticket.order.id }} · {{ ticket.order.bike.brand }} {{ ticket.order.bike.model }}
      </p>
      <div class="small" style="margin-top:6px;">
        Zákazník: {{ ticket.order.bike.customer.full_name|default:ticket.order.bike.customer.email }}
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn btn-light" href="{% url 'admin_ticket_list' %}">Späť</a>
      <a class="btn btn-light" href="{% url 'service_order_admin_detail' ticket.order.id %}">Otvoriť servis</a>
    </div>
  </div>

  <div class="chat-grid">
    <div class="chat-card">
      <div class="chat-messages" id="chat-messages">
        {% for m in ticket.messages.all|dictsort:"created_at" %}
          {% if m.role == "CUSTOMER" %}
            <div class="msg-row right">
              <div class="msg customer">
                {{ m.message }}
                <div class="msg-meta">Zákazník · {{ m.created_at|date:"d.m.Y H:i" }}</div>
              </div>
            </div>
          {% else %}
            <div class="msg-row left">
              <div class="msg">
                {{ m.message }}
                <div class="msg-meta">Servis · {{ m.created_at|date:"d.m.Y H:i" }}</div>
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="small" style="color:var(--muted); font-weight:800;">
            Zatiaľ tu nie je žiadna správa.
          </div>
        {% endfor %}
      </div>

      {% if is_closed %}
        <div style="padding:12px 14px; border-top:1px solid var(--line); color:var(--muted); font-weight:800;">
          Ticket je zatvorený.
        </div>
      {% else %}
        <div class="chat-form">
          <form method="post">
            {% csrf_token %}

            <div class="label">Odpoveď</div>
            <textarea class="input" name="message" rows="2" style="margin-top:8px; resize:vertical;" placeholder="Napíš odpoveď"></textarea>

            <div class="chat-actions">
              <button class="btn btn-orange" type="submit">Odoslať</button>
            </div>
          </form>
        </div>
      {% endif %}
    </div>

    <div class="side-card">
      <div class="pad">
        <div class="side-title">Status</div>

        <form method="post" style="display:grid; gap:10px;">
          {% csrf_token %}

          <select class="input" name="status" style="padding-right:34px;">
            {% for s in status_choices %}
              <option value="{{ s.0 }}" {% if ticket.status == s.0 %}selected{% endif %}>{{ s.1 }}</option>
            {% endfor %}
          </select>

          <button class="btn btn-dark" type="submit">Uložiť status</button>

          {% if not is_closed %}
            <button class="btn btn-light" type="submit" name="close" value="1">Zatvoriť ticket</button>
          {% endif %}
        </form>

        <div class="small" style="margin-top:12px;">
          Keď odošleš odpoveď, ticket sa prepne na Čaká na zákazníka.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const el = document.getElementById("chat-messages");
    if (el){ el.scrollTop = el.scrollHeight; }
  })();
</script>
{% endblock %}
